---
title: "MCC NSE CHA"
author: "Kenneth Daily"
date: "01/28/2015"
output: html_document
---


```{r libs, message=FALSE, warning=FALSE, echo=FALSE}
library(ggplot2)
library(reshape)
library(plyr)
library(dplyr)
library(RColorBrewer)
library(knitr)
library(xtable)
library(gridExtra)

options(xtable.type="html", xtable.caption.placement="top", xtable.include.row.names=FALSE)
opts_chunk$set(comment=NA, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.width=10, fig.height=5)

lab.thresh.NSE <- 17
lab.thresh.ChrAnew <- 84.7
```

```{r loaddata}

data <- read.delim("data/NSE_ChrA_all_values_categorical.csv", sep=",", na.strings="",
                   colClasses=c("factor", "character", "numeric", "factor", "numeric", 
                                "numeric", "factor", "factor", "factor", "factor"),
                   )

data <- transform(data,
                  Date=as.Date(Date, format="%m/%d/%Y"))

datedays <- ddply(data, .(PtNum), 
                  function(x) data.frame(DateDays=difftime(x$Date, min(x$Date), units="days")))

data$DateDays <- as.numeric(datedays$DateDays)

progression <- data %>% 
  group_by(PtNum) %>% 
  summarise(progressed=ifelse(sum(Rec == 1) > 1, 
                              "Progression",
                              "No Progression"))

data <- left_join(data, progression, by="PtNum")
data$progressed <- factor(data$progressed)

chra.old.cutpoints <- c(0, 25, 53.75, 1000)
chra.new.cutpoints <- c(0, 84.7, 105.65, 1000)

# foo <- ddply(data.merge, .(PtNum), ddpfcl)
# colnames(foo) <- c("PtNum", "mintestdate")
# bar <- merge(data.merge, foo, by="PtNum")
# head(data.merge[, c("beforeprogression", "progressed", "progfree", "firstprg", "firstprgdays")])

```

### NSE data per patient

```{r nseplot1}
nse.cutpoints <- data.frame(y=c(17, 24.3))
```

```{r nseplot2, fig.width=15, fig.height=7}
# pointspersample <- ddply(data.merge, .(PtNum), nrow)
# samples.keep <- subset(pointspersample, V1 > 3)$PtNum
# samples.keep <- c(18, 31, 38, 53, 64, 8)
# samples.keep <- metadata$id

plot.data <- subset(data, !is.na(NSE))

plot.nse <- function(data) {
  p <- ggplot(data, aes(x=DateDays, y=NSE, group=PtNum))
  p <- p + geom_line(size=1)
  p <- p + geom_point(aes(color=Txend), size=4)
  
  recpoints <- subset(data, Rec == 1)
  
  p <- p + geom_vline(data=recpoints, aes(xintercept=DateDays))
  
  p <- p + facet_wrap(~ PtNum, scale="free_x")  
  p <- p + scale_color_manual(values=c("black", "red"))
  
  p <- p + theme_bw()
  p <- p + theme(legend.position="none")
  
  p
}

p.progressed <- plot.nse(data=subset(plot.data, progressed == "Progression"))
p.progressed <- p.progressed + labs(x="Days from Dx", y="NSE (ug)", title="Progression")

p.noprogressed <- plot.nse(data=subset(plot.data, progressed == "No Progression"))
p.noprogressed <- p.noprogressed + labs(x="Days from Dx", title="No Progression")

png("NSE.png", width=1200, height=750)
grid.arrange(p.noprogressed, p.progressed, ncol=2)
dev.off()

```

```{r plotchracat, fig.width=15, fig.height=7}
plot.chra <- function(plot.data) {
  p <- ggplot(plot.data, aes(x=DateDays, y=ChrA_cat, group=PtNum))
  
  p <- p + geom_line(size=1)
  p <- p + geom_point(aes(color=Txend), size=4)

  recpoints <- subset(plot.data, Rec == 1)  
  p <- p + geom_vline(data=recpoints, aes(xintercept=DateDays))

  p <- p + facet_wrap(~ PtNum, scale="free_x")
  
  p <- p + scale_color_manual(values=c("black", "red"))
  p <- p + scale_shape_manual(values=c(1, 16))
  
  p <- p + theme_bw()
  p <- p + theme(legend.position="none")
  p
}

plot.data <- subset(data, !is.na(ChrA_cat))

p.progressed <- plot.chra(subset(plot.data, progressed == "Progression"))
p.progressed <- p.progressed + labs(x="Days from Dx", y="ChrA categorical level", title="Progression")

p.noprogressed <- plot.chra(subset(plot.data, progressed == "No Progression"))
p.noprogressed <- p.noprogressed + labs(x="Days from Dx", y="ChrA categorical level", title="No Progression")

png("ChrA_cat.png", width=1200, height=750)
grid.arrange(p.noprogressed, p.progressed, ncol=2)
dev.off()

```