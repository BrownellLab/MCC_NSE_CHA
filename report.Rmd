---
title: "MCC NSE CHA"
author: "Kenneth Daily"
date: "01/28/2015"
output: html_document
---


```{r libs, message=FALSE, warning=FALSE, echo=FALSE}
library(ggplot2)
library(reshape)
library(plyr)
library(dplyr)
library(RColorBrewer)
library(knitr)
library(xtable)
library(gridExtra)

options(xtable.type="html", xtable.caption.placement="top", xtable.include.row.names=FALSE)
opts_chunk$set(comment=NA, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.width=10, fig.height=5)

lab.thresh.NSE <- 17
lab.thresh.ChrAnew <- 84.7
```

```{r loaddata}

data <- read.delim("data/NSE_ChrA_all_values_categorical.csv", sep=",", na.strings="",
                   colClasses=c("factor", "character", "numeric", "factor", "numeric", 
                                "numeric", "factor", "factor", "factor", "factor"),
                   )

data.merge <- data

data.merge <- transform(data.merge,
                        Date=as.Date(Date, format="%m/%d/%Y"))

datedays <- ddply(data.merge, .(PtNum), 
                  function(x) data.frame(DateDays=difftime(x$Date, min(x$Date), units="days")))

data.merge$DateDays <- datedays$DateDays

chra.old.cutpoints <- c(0, 25, 53.75, 1000)
chra.new.cutpoints <- c(0, 84.7, 105.65, 1000)

# data.merge <- transform(data.merge,
#                         ChrAo.cut=cut(ChrAo, breaks=chra.old.cutpoints, 
#                                       labels=c("WNL", "above normal", "high"),
#                                       ordered_result=TRUE),
#                         ChrAn.cut=cut(ChrAn, breaks=chra.new.cutpoints,
#                                       labels=c("WNL", "above normal", "high"),
#                                       ordered_result=TRUE)
#                         )
# 
# data.merge$ChrA.cut <- factor(with(data.merge, ifelse(is.na(ChrAn.cut), as.character(ChrAo.cut), as.character(ChrAn.cut))),
#                               levels=c("WNL", "above normal", "high"), ordered=TRUE)

# foo <- ddply(data.merge, .(PtNum), ddpfcl)
# colnames(foo) <- c("PtNum", "mintestdate")
# bar <- merge(data.merge, foo, by="PtNum")
# head(data.merge[, c("beforeprogression", "progressed", "progfree", "firstprg", "firstprgdays")])

```

### NSE data per patient

```{r nseplot1}
nse.cutpoints <- data.frame(y=c(17, 24.3))
```

```{r nseplotfxn}

plotNSE <- function(plot.data, nsecutpoints=NA, title=NA, ...) {  
  p
  
}

```


```{r nseplot2, fig.width=15, fig.height=7}
# pointspersample <- ddply(data.merge, .(PtNum), nrow)
# samples.keep <- subset(pointspersample, V1 > 3)$PtNum
# samples.keep <- c(18, 31, 38, 53, 64, 8)
# samples.keep <- metadata$id
plot.data <- subset(data.merge, !is.na(NSE))

p <- ggplot(plot.data, aes(x=as.numeric(DateDays), y=NSE, group=PtNum))
p <- p + geom_line(size=1)
p <- p + geom_point(aes(color=Rec, shape=Txend), size=4)

p <- p + facet_wrap(~ PtNum, scale="free_x")
p <- p + labs(x="Days from Dx", y="NSE (ug)", title="NSE")

p <- p + scale_color_manual(values=c("black", "red"))
p <- p + scale_shape_manual(values=c(1, 16))

p <- p + theme_bw()
# p <- p + theme(legend.position="none")

p

ggsave(filename = "NSE.png", plot=p, width=14, height=10)

# p.progressed <- plot.nse(subset(plot.data, progressed == "Progression"), nse.cutpoints, title="Progression")
# p.noprogressed <- plot.nse(subset(plot.data, progressed == "No Progression"), nse.cutpoints, title="No Progression")
# 
# grid.arrange(p.noprogressed, p.progressed, ncol=2)

```

```{r plotchracat, fig.width=15, fig.height=7}
plot.data <- subset(data.merge, !is.na(ChrA_cat))

p <- ggplot(plot.data, aes(x=as.numeric(DateDays), y=ChrA_cat, group=PtNum))

p <- p + geom_line(size=1)
p <- p + geom_point(aes(color=Rec, shape=Txend), size=4)

p <- p + facet_wrap(~ PtNum, scale="free")
p <- p + labs(x="Days from Dx", y="ChrA categorical level", title="ChrA_cat")

p <- p + scale_color_manual(values=c("black", "red"))
p <- p + scale_shape_manual(values=c(1, 16))

p <- p + theme_bw()
# p <- p + theme(legend.position="none")
p

ggsave(filename = "ChrA_cat.png", plot=p, width=14, height=10)

# p.progressed <- plot.chra(subset(plot.data, progressed == "Progression"), title="Progression")
# p.noprogressed <- plot.chra(subset(plot.data, progressed == "No Progression"), title="No Progression")
# 
# grid.arrange(p.noprogressed, p.progressed, ncol=2)


```